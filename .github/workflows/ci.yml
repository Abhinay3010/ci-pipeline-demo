name: Full CI Pipeline (Multi-Stage)

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:

  # --------------------------------------------------------
  # 1Ô∏è‚É£ CODE BUILD STAGE
  # --------------------------------------------------------
  build:
    name: Stage 1 ‚Äî Build & Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Source Code
      uses: actions/checkout@v4

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17
        cache: maven

    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        projectBaseDir: .

    - name: Maven Build
      run: mvn -B package

    - name: Upload Build Artifact (JAR)
      uses: actions/upload-artifact@v4
      with:
        name: app-jar
        path: target/*.jar

  # --------------------------------------------------------
  # 2Ô∏è‚É£ SBOM GENERATION
  # --------------------------------------------------------
  sbom:
    name: Stage 2 ‚Äî Generate SBOM (Syft)
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout Source Code
      uses: actions/checkout@v4

    - name: Generate SBOM using Syft
      uses: anchore/syft-action@v0.6.0
      with:
        output-file: sbom.json

    - name: Upload SBOM
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: sbom.json

  # --------------------------------------------------------
  # 3Ô∏è‚É£ VULNERABILITY SCAN USING GRYPE
  # --------------------------------------------------------
  grype:
    name: Stage 3 ‚Äî Vulnerability Scan (Grype)
    runs-on: ubuntu-latest
    needs: sbom

    steps:
    - name: Download SBOM
      uses: actions/download-artifact@v4
      with:
        name: sbom

    - name: Scan SBOM using Grype
      uses: anchore/grype-action@v0.7.0
      with:
        sbom: sbom.json

  # --------------------------------------------------------
  # 4Ô∏è‚É£ DOCKER BUILD STAGE
  # --------------------------------------------------------
  docker_build:
    name: Stage 4 ‚Äî Build Docker Image
    runs-on: ubuntu-latest
    needs: grype

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Build Docker Image
      run: docker build -t demo-app:latest .

    - name: Save Docker Image as TAR
      run: docker save demo-app:latest -o demo-app.tar

    - name: Upload Docker TAR
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: demo-app.tar

  # --------------------------------------------------------
  # 5Ô∏è‚É£ DOCKER TRIVY SCAN
  # --------------------------------------------------------
  trivy:
    name: Stage 5 ‚Äî Trivy Image Scan
    runs-on: ubuntu-latest
    needs: docker_build

    steps:
    - name: Download Docker Image TAR
      uses: actions/download-artifact@v4
      with:
        name: docker-image

    - name: Load Docker Image
      run: docker load -i demo-app.tar

    - name: Trivy Image Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: demo-app:latest
        exit-code: 0

  # --------------------------------------------------------
  # 6Ô∏è‚É£ DUMMY ARTIFACTORY UPLOAD
  # --------------------------------------------------------
  upload:
    name: Stage 6 ‚Äî Dummy Upload to Artifactory
    runs-on: ubuntu-latest
    needs: trivy

    steps:
    - name: Final Stage - Simulated Upload
      run: |
        echo "Uploading build to Artifactory (simulated)..."
        echo "Pipeline Completed Successfully üéâ"
